<div class="container">
  <h3>Cartes Enregistrées</h3>
  <p>Mes cartes de crédit</p>

  <% if @stripe_sources.nil? %>
    <p>Vous n'avez aucune carte de crédit, Ajoutez en une dès maintenant !</p>
  <% else %>
    <ul>
      <% @stripe_sources.data.each do |card_data| %>
        <li>
          <%= "#{card_data.brand.upcase} se terminant par : #{card_data.last4}" %> -
          <%= link_to 'supprimer', credit_card_path(card_data.id), method: :delete %>
        </li>
      <% end %>
    </ul>
  <% end %>

  <!-- Trigger modal with cb form -->
  <div class="padded text-center">
    <button type="button" class="button button-blue" data-toggle="modal" data-target="#credit-card-modal">
      Ajouter une carte
    </button>
  </div>
</div>

<div class="modal fade" id="credit-card-modal" tabindex="-1" role="dialog" aria-labelledby="creditCardModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="creditCardModalLabel">Ajouter une carte</h4>
      </div>
      <div class="modal-body" style='padding: 15px;'>

        <%= simple_form_for :credit_card, url: credit_cards_path, remote: true, authenticity_token: true, html: { id: 'card-form' } do |f| %>
          <div id="card-element"></div>
          <div id="card-errors" role="alert"></div>
          <%= f.input :stripe_token, as: :hidden %>
          <div class="light-padded text-center">
            <%= f.submit 'Ajouter une carte', class: 'button button-white', id: 'add-card' %>
          </div>
        <% end %>

      </div>
      <div class="modal-footer"></div>
    </div>
  </div>
</div>

<script>
  var stripe = Stripe('<%= ENV['STRIPE_PUBLISHABLE_KEY'] %>');
  var elements = stripe.elements();

  var style = {
    base: {
      fontSize: '16px',
      lineHeight: '24px',
      color: '#FFFFFF',
      iconColor: '#FFFFFF',
      '::placeholder': {
        color: '#c9c9c9',
      }
    }
  };

  var card = elements.create('card', {style: style});

  function stripeTokenHandler(token) {
    // Insert the token ID into the form so it gets submitted to the server
    var form = document.getElementById('card-form');
    var hiddenInput = document.getElementById('credit_card_stripe_token');
    hiddenInput.setAttribute('value', token.id);

    // Submit the form
    form.submit();
  }

  document.addEventListener("turbolinks:load", function() {
    card.mount('#card-element');

    card.addEventListener('change', function(event) {
      var displayError = document.getElementById('card-errors');
      if (event.error) {
        displayError.textContent = event.error.message;
      } else {
        displayError.textContent = '';
      }
    });

    var form = document.getElementById('card-form');
    form.addEventListener('submit', function(event) {
      var button = document.getElementById('add-card');
      event.preventDefault();
      event.stopPropagation();

      stripe.createToken(card).then(function(result) {
        if (result.error) {
          // Inform the user if there was an error
          var errorElement = document.getElementById('card-errors');
          errorElement.textContent = result.error.message;
        } else {
          // Send the token to your server
          stripeTokenHandler(result.token);
        }
      });
    });

  });
</script>
