<% content_for :navbar_back_url, cookoon_path(@reservation.cookoon) %>

<div class="container"
     data-controller="payments"
     data-payments-amounts-url = "<%= amounts_reservation_payments_path(@reservation.id) %>"
     data-payments-discount="false"
>
  <h2>Payez votre réservation</h2>

  <b>Votre location :</b>
  <br><br>
  <p>le <b><%= display_datetime_for(@reservation.start_at) %></b> pour <b><%= display_duration_for(@reservation) %></b></p>

  <p>Vos services pour <%= @reservation.people_count %> personnes</p>

  <div class='d-flex justify-content-around'>
    <% @service_categories.each do |category| %>
      <div data-action="serviceChanged->payments#priceChanged">
        <%= c 'service', category: category, url: reservation_services_path(@reservation), method: 'post' %>
      </div>
    <% end %>
  </div>

  <div class="pt-4 pb-3">
    <div class="d-flex-default mb-2">
      Prix de la location
      <span><%= humanized_money_with_symbol @reservation.price %></span>
    </div>

    <div class="d-flex-default mb-2">
      Prix des services
      <span data-target="payments.servicesPrice"><%= humanized_money_with_symbol 0 %></span>
    </div>

    <div class="d-flex-default mb-2">
      Frais de service
      <span><%= humanized_money_with_symbol @reservation.tenant_fee %></span>
    </div>

    <hr>

    <div class="d-flex-default mb-2">
      <b data-target="payments.chargeAmountLabel">TOTAL</b>
      <b data-target="payments.chargeAmount"><%= humanized_money_with_symbol @reservation.price_with_tenant_fee %></b>
    </div>
  </div>

  <!-- ========= CARD SELECTION ============= -->
  <% if @credit_cards.blank? %>
    <div class="text-center py-3">
      <div class="py-3">
        <p>Vous n'avez aucun moyen de paiement</p>
        <% if current_user.available_discount? %>
          <p>
            Vous devez en ajouter un afin de pouvoir <b>profiter de vos <%= humanized_money_with_symbol current_user.discount_balance %>
            de crédit.</b>
          </p>
        <% else %>
          <p>Vous devez en ajouter un avant de pouvoir faire une demande de réservation</p>
        <% end %>
      </div>
      <%= link_to 'Ajouter une carte', "#", class: 'button button-blue', data: {toggle: "modal", target: "#credit-card-modal"} %>
    </div>
  <% else %>
    <% if current_user.available_discount? %>
      Cliquez pour utiliser votre crédit sur cette location (disponible jusqu'au : <%= display_date_for(current_user.discount_expires_at) %>)

        <div class="payment-block" data-action="click->payments#toggleDiscount" data-target="payments.discountButton">
          <b><span data-target="payments.userDiscountLabel">Crédit disponible</span> : <span data-target="payments.userDiscountBalance"><%= humanized_money_with_symbol current_user.discount_balance %></span></b>
          <i class='co co-check'></i>
        </div>
    <% end %>

    <%= render 'form' %>
    <div class="text-center py-3">
      <%= link_to 'Ajouter une carte', "#", data: {toggle: "modal", target: "#credit-card-modal"} %>
    </div>
    <div class="text-center">
      <div style="font-size:12px; margin-top: 15px">
        <p>
          Votre carte bleue ne sera débitée que si l'Hôte accepte votre demande de location.
        </p>
        <p>
          Attention : nous procédons tout de même à une demande d'autorisation de paiement sur votre compte.
        </p>
      </div>
    </div>
  <% end %>
  <!-- ========= END CARD SELECTION ============= -->
</div>

<%= render 'credit_cards/modal' %>
